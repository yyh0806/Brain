# RViz 持久化地图显示指南

## ⚠️ 重要提示

**所有脚本都使用 `ROS_DOMAIN_ID=42`**

确保所有进程在同一个ROS域中通信！

---

## 快速开始

```bash
# 启动RViz（会自动设置ROS_DOMAIN_ID=42）
bash start_rviz2.sh
```

RViz会自动加载预配置的持久化地图显示布局。

---

## 如何查看持久化地图

### 方法1: 使用自动配置（推荐）

启动RViz后，**已经自动配置好**，直接观察即可：

1. **Occupancy Grid面板** - 在3D视图中占据栅格地图会自动显示
   - **黑色** = 障碍物（占据）
   - **白色** = 自由空间（可通行）
   - **灰色** = 未知区域（未探索）

2. **左侧Displays面板** - 查看所有显示项
   - `Occupancy Grid` - 占据栅格地图（已启用）
   - `PointCloud2` - 3D点云
   - `RGB Camera` - 相机画面
   - `Odometry` - 机器人里程计
   - `TF` - 坐标变换树

### 方法2: 手动添加（如果自动配置失败）

如果在左侧面板中没有看到 `Occupancy Grid`：

1. **点击左上角的 "+" 按钮**
2. **选择 "By topic" 标签页**
3. **找到并选择 `/map` 话题**
4. **点击 "OK"**

或者手动配置：
1. 点击 "+"
2. 选择 "Map"
3. 在左侧面板中展开新添加的Map项
4. 设置 `Topic` 为 `/map`
5. 设置 `Color Scheme` 为 `map`
6. 调整 `Alpha` 到 0.7-0.9（透明度）

---

## 调整地图显示

### 如果地图不清晰

1. **调整透明度（Alpha值）**
   - 在左侧面板找到 `Occupancy Grid`
   - 展开 `Occupancy Grid`
   - 找到 `Alpha` 参数
   - 调整到 **0.7-0.9**
   - 值越大，颜色越不透明，越清晰

2. **调整颜色方案**
   - 在 `Occupancy Grid` 中
   - 找到 `Color Scheme`
   - 选择 `map`（标准占据地图配色）
   - 其他选项：
     - `costmap` - 代价地图配色
     - `raw` - 原始值配色

3. **调整视图高度**
   - 滚动鼠标滚轮缩放
   - 左键拖动旋转
   - 中键拖动平移
   - 建议从上往下俯视（Pitch约60-80度）

### 如果地图更新太慢

1. **降低Frame Rate**
   - RViz顶部菜单 → `Panels` → `Views` → `Frame Rate`
   - 从 30 降到 15-20

2. **暂时关闭点云**
   - 在左侧面板取消勾选 `PointCloud2`
   - 占据地图会更流畅

---

## 持久化验证要点

### 观察重点

在Occupancy Grid面板中，重点观察以下4个方面：

#### 1. 障碍物稳定性 ⭐

**观察方法**：
- 找一个明显的障碍物（如墙壁、柜子）
- 持续观察该区域在rosbag播放过程中的变化

**正确行为（持久化正常）**：
```
t=5s:   黑色（障碍物）
t=10s:  黑色（保持）✓
t=15s:  黑色（保持）✓
t=20s:  黑色（保持）✓
```

**错误行为（持久化失败）**：
```
t=5s:   黑色
t=10s:  白色（丢失！）
t=15s:  黑色（又回来了）
t=20s:  白色（不稳定）
```

#### 2. 自由空间扩展 ⭐

**观察方法**：
- 观察机器人周围区域
- 随着时间推移，自由空间应该向外扩展

**正确行为**：
```
t=0s:   机器人周围5米：灰色（未知）
t=10s:  内圈3米：白色（已探索）
        3-5米：灰色（未探索）
t=20s:  5米内：白色
t=30s:  10米内：白色（扩展）✓
```

**关键验证**：
- 自由空间从机器人位置向外扩展（射线填充）
- 扩展方向应该是连续的，不是跳跃的

#### 3. 已知区域保持 ⭐

**观察方法**：
- 找一个已经被标记为黑/白的区域
- 观察该区域是否保持颜色不变

**正确行为**：
```
t=10s:  区域[20,20] = 白色
t=20s:  区域[20,20] = 白色（保持）✓
t=30s:  区域[20,20] = 白色（保持）✓

t=10s:  区域[30,30] = 黑色
t=20s:  区域[30,30] = 黑色（保持）✓
t=30s:  区域[30,30] = 黑色（保持）✓
```

**错误行为**：
```
t=10s:  白色
t=20s:  灰色（退回到未知！）✗
```

#### 4. 贝叶斯更新 ⭐

**原理**：
不是简单覆盖，而是概率更新。一次自由观测不会立即改变占据状态。

**观察方法**：
由于更新很快，需要快速观察或慢放rosbag。

**正确行为**：
```
初始:   灰色（UNKNOWN）
检测到:  黑色（OCCUPIED）
误报:    黑色（保持，概率略微降低）
继续误报: 黑色（保持）
多次误报: 白色（FREE，概率降低到阈值）✓
```

**关键验证**：
- [ ] 一次自由观测不立即变为白色
- [ ] 需要多次观测才会改变状态
- [ ] 变化是渐进的

---

## 实际操作步骤

### 步骤1: 启动RViz
```bash
bash start_rviz2.sh
```

### 步骤2: 观察地图
RViz启动后，在3D视图中应该能看到：
- 灰色网格（地图容器）
- 逐渐出现的黑色区域（障碍物）
- 逐渐扩展的白色区域（自由空间）

### 步骤3: 验证持久化

#### 验证1: 障碍物稳定性（1分钟）
1. 找一个明显的黑色障碍物
2. 记住它的位置
3. 观察1分钟
4. 确认它持续保持黑色 ✓

#### 验证2: 自由空间扩展（2分钟）
1. 观察机器人周围
2. 记录白色区域的范围
3. 每30秒记录一次
4. 确认白色区域逐渐向外扩展 ✓

#### 验证3: 已知区域保持（2分钟）
1. 找一个已标记的区域（黑或白）
2. 持续观察
3. 确认颜色不变 ✓

### 步骤4: 调整视图（可选）

如果需要更好的观察角度：
1. **俯视地图** - 调整Pitch到60-80度
2. **拉近观察细节** - 滚轮放大
3. **保存视图** - Views → Current View → Save

---

## 故障排查

### 问题1: Occupancy Grid不显示

**可能原因**：
- `/map` 话题未发布
- 配置文件未正确加载

**解决方法**：
```bash
# 检查/map话题是否存在
ros2 topic list | grep map

# 查看话题详情
ros2 topic info /map

# 查看话题数据
ros2 topic echo /map --once
```

如果话题不存在，检查Brain系统是否正确启动。

### 问题2: 地图全灰（无数据）

**可能原因**：
- OccupancyMapper未启用
- 传感器数据未正确接收

**解决方法**：
1. 检查Point Cloud是否显示
2. 检查Odometry是否更新
3. 查看Brain系统日志

### 问题3: 地图闪烁

**可能原因**：
- 更新频率过高
- 电脑性能不足

**解决方法**：
1. 降低RViz的Frame Rate（30→15）
2. 暂时关闭PointCloud2
3. 调整Occupancy Grid的Alpha值

### 问题4: 颜色不清晰

**解决方法**：
1. 调整Alpha值到0.9（最大不透明）
2. 切换Color Scheme到`map`
3. 调整视图到更好的角度

---

## 验证清单

使用此清单验证持久化地图的正确性：

### 基础显示
- [ ] RViz成功启动
- [ ] Occupancy Grid面板可见
- [ ] 地图颜色正常（黑/白/灰）
- [ ] 地图持续更新

### 持久化验证
- [ ] 障碍物（黑色）稳定不变
- [ ] 自由空间（白色）逐渐扩展
- [ ] 已知区域不退回到未知（灰色）
- [ ] 贝叶斯更新生效（一次观测不立即改变）

### 数据质量
- [ ] 地图更新流畅（不卡顿）
- [ ] Point Cloud显示正常
- [ ] 机器人位姿正确
- [ ] TF坐标系对齐

---

## 进阶技巧

### 保存自定义视图

1. 调整到满意的观察角度
2. Views → Current View → Save
3. 输入视图名称（如"Top Down"）
4. 下次点击Saved列表快速切换

### 多视图对比

1. Views → Create New View
2. 调整到不同角度
3. 保存
4. 快速切换对比

### 截图记录

1. 调整到好的观察角度
2. RViz顶部菜单 → File → Screenshot
3. 保存对比不同时刻的地图状态

---

## 总结

使用RViz查看持久化地图的关键点：

✅ **启动后自动配置** - 无需手动设置
✅ **Occupancy Grid面板** - 核心显示，关注黑/白/灰
✅ **调整Alpha到0.7-0.9** - 提高清晰度
✅ **从上往下俯视** - 最佳观察角度
✅ **验证3大要点** - 障碍物稳定性、自由空间扩展、已知区域保持

如果遇到问题，请参考"故障排查"部分。

