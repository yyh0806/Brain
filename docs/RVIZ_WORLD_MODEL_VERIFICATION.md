# RViz 世界模型验证指南

## 概述

本指南将帮助你使用RViz验证世界模型的持久化机制。RViz是ROS2的标准可视化工具，比WebViz更稳定和成熟。

## 快速开始

### 步骤1: 启动世界模型监控助手

在第一个终端中：

```bash
cd /media/yangyuhui/CODES1/Brain
python3 scripts/verify_world_model_rviz.py
```

这个脚本会实时显示世界模型的统计信息，帮助你验证持久化机制。

### 步骤2: 启动RViz

在第二个终端中：

```bash
cd /media/yangyuhui/CODES1/Brain
bash scripts/start_rviz_perception.sh
```

RViz会自动启动并加载预配置的布局，包含所有需要的显示面板。

### 步骤3: 播放rosbag

在第三个终端中（如果还没播放）：

```bash
cd /media/yangyuhui/CODES1/Brain
ros2 bag play data/rosbags/<你的rosbag文件>
```

## RViz面板说明

### 1. RGB Camera（相机画面）

- **话题**: `/front_stereo_camera/left/image_raw`
- **用途**: 查看机器人实时相机画面
- **位置**: RViz窗口下方，点击"RGB Camera"标签切换

**使用提示**:
- 点击下方的"RGB Camera"标签显示相机画面
- 可以调整面板大小以获得更好的视图

### 2. Point Cloud（3D点云）

- **话题**: `/front_3d_lidar/lidar_points`
- **颜色**: 白色点云
- **大小**: 0.05米
- **样式**: Points（点状）

**使用提示**:
- 使用鼠标左键拖动旋转视图
- 使用鼠标中键拖动平移视图
- 滚轮缩放视图
- 双击3D视图中的物体可以聚焦

### 3. Occupancy Grid（占据栅格地图）⭐ 核心验证项

- **话题**: `/map`
- **颜色方案**: map（标准占据地图配色）
- **透明度**: 0.7

**颜色含义**:
- **黑色** = 占据（障碍物）
- **白色** = 自由（可通行空间）
- **灰色** = 未知（未探索区域）

**验证重点**:
- 障碍物是否稳定存在（保持黑色）
- 自由空间是否逐渐扩展（从机器人位置向外变白）
- 已探索区域是否保持已知（不变回灰色）

### 4. TF（坐标变换树）

- 显示所有坐标系关系
- 包括：odom, base_link, camera_link, lidar_link等
- 用于验证坐标系配置是否正确

### 5. RobotModel（机器人模型）

- 显示机器人的3D模型
- 基于URDF描述
- 在3D视图中与实际数据对齐

### 6. Robot Path（机器人轨迹）

- **话题**: `/plan`
- **颜色**: 绿色
- **样式**: Lines

**用途**: 显示机器人规划或实际行驶的路径

### 7. Laser Scan（激光扫描）- 可选

- **话题**: `/scan`
- **颜色**: 红色
- **样式**: Points

**用途**: 显示2D激光雷达数据（如果有）

### 8. Semantic Objects（语义物体）- 可选

- **话题**: `/semantic_objects`
- 显示检测到的语义物体标记

## 世界模型持久化验证

### 1. 占据地图持久化（在Occupancy Grid面板中验证）

#### 验证方法

观察RViz中的Occupancy Grid面板，重点检查以下3个方面：

#### A. 障碍物稳定性测试

**目标**: 验证障碍物（黑色区域）在多次扫描后保持稳定

**操作步骤**:
1. 找到地图中一个明显的障碍物（如墙壁、柜子）
2. 观察该区域在rosbag播放过程中的变化
3. 该区域应该持续保持黑色（占据状态）

**正确行为（持久化正常）**:
```
t=0s:   区域[10,10] = 灰色（未知）
t=5s:   区域[10,10] = 黑色（首次检测到障碍物）
t=10s:  区域[10,10] = 黑色（保持）
t=15s:  区域[10,10] = 黑色（保持）
t=20s:  区域[10,10] = 黑色（保持稳定）✓
```

**错误行为（持久化失败）**:
```
t=5s:   区域[10,10] = 黑色
t=10s:  区域[10,10] = 白色（丢失障碍物！）✗
t=15s:  区域[10,10] = 黑色（又回来了）✗
t=20s:  区域[10,10] = 白色（不稳定）✗
```

#### B. 自由空间扩展测试

**目标**: 验证自由空间（白色区域）从机器人位置向外逐渐扩展

**操作步骤**:
1. 观察机器人周围区域（机器人位置附近）
2. 随着rosbag播放，自由空间应该逐渐向外扩展
3. 从机器人到障碍物的路径应该逐渐变为白色

**正确行为（自由空间扩展正常）**:
```
t=0s:   机器人周围5米范围内：灰色（未知）
t=10s:  机器人周围3米范围内：白色（已探索）
        3-5米范围：灰色（未探索）
t=20s:  机器人周围5米范围内：白色（已扩展）
        5-7米范围：灰色（未探索）
t=30s:  机器人周围10米范围内：白色（继续扩展）✓
```

**关键验证点**:
- 自由空间应该从机器人位置向外扩展（射线填充算法）
- 已变为白色的区域应该保持白色（不应该变回灰色）

#### C. 已知区域保持测试

**目标**: 验证已探索区域不退回到未知状态

**操作步骤**:
1. 找到一个已经被标记为黑色（障碍物）或白色（自由空间）的区域
2. 观察该区域在后续扫描中是否保持状态
3. 该区域不应该变回灰色（未知）

**正确行为（已知区域保持正常）**:
```
t=10s:  区域[20,20] = 白色（已探测为自由空间）
t=15s:  区域[20,20] = 白色（保持）
t=20s:  区域[20,20] = 白色（保持）
t=30s:  区域[20,20] = 白色（保持，不退回到未知）✓

t=10s:  区域[30,30] = 黑色（已探测为障碍物）
t=15s:  区域[30,30] = 黑色（保持）
t=20s:  区域[30,30] = 黑色（保持，即使传感器误报也不变）✓
```

**错误行为（已知区域保持失败）**:
```
t=10s:  区域[20,20] = 白色
t=20s:  区域[20,20] = 灰色（退回到未知！）✗
```

### 2. 贝叶斯更新机制验证

#### 核心原理

贝叶斯更新不是简单的覆盖：`grid[x,y] = OCCUPIED`，而是基于概率的更新：
- 如果当前是占据（概率高），一次自由观测不会立即将其变为自由
- 需要多次自由观测才会降低占据概率

#### 验证方法

在RViz中观察某个栅格从未知到占据再到自由的过程：

**测试场景**: 传感器对同一区域产生不一致的观测

**正确行为（贝叶斯更新正确）**:
```
t=0s:   grid[10,10] = 灰色（UNKNOWN，概率=0.5）
t=5s:   检测到障碍物 → grid[10,10] = 黑色（OCCUPIED，概率=0.95）
t=10s:  传感器误报检测为自由 → grid[10,10] = 黑色（保持OCCUPIED）
        (概率从0.95降到0.92，但仍>0.7，所以保持占据)
t=15s:  又一次误报 → grid[10,10] = 黑色（保持OCCUPIED）
        (概率从0.92降到0.88，仍>0.7)
t=20s:  持续误报3次 → grid[10,10] = 黑色（保持OCCUPIED）
        (概率降到0.75，仍>0.7)
t=25s:  持续误报5次 → grid[10,10] = 白色（FREE）
        (概率降到0.65，<0.7阈值，变回自由)
```

**关键验证点**:
- [ ] 一次自由观测不立即改变占据状态
- [ ] 需要多次不一致观测才会改变状态
- [ ] 变化过程是渐进的，不是突变的

#### RViz观察方法

由于更新过程很快（每秒多次），RViz可能难以直接观察到渐进变化。你可以：

1. **降低更新频率**（如果可能）
   - 修改Brain配置中的地图更新频率

2. **观察统计信息**
   - 查看终端中`verify_world_model_rviz.py`输出的统计
   - 关注占据/自由/未知栅格数量

3. **截图对比**
   - 在不同时间点截图对比
   - 观察地图的变化趋势

### 3. 语义物体持久化验证

#### 验证方法

在RViz中，Semantic Objects面板会显示检测到的语义物体（如果有）。

**观察重点**:
- 物体的update_count是否持续递增
- 物体的confidence是否随观测次数提升

**注意**: RViz本身不直接显示置信度和更新计数，你需要结合终端中`verify_world_model_rviz.py`的输出。

**终端输出示例**:
```
【占据栅格地图】
  更新次数: 150
  最后更新: 2025-12-26 10:30:15

  栅格分布:
    ■ 占据 (障碍物):   1,234 (  5.2%)
    □ 自由 (可通行):  15,678 ( 66.3%)
    ? 未知 (未探索):   6,788 ( 28.5%)

【持久化验证】
  ✓ 占据区域存在 (1,234 个栅格)
  ✓ 自由空间存在 (15,678 个栅格)
  ✓ 已探索超过50% (71.5%)
```

### 4. 时间衰减机制验证

#### 验证方法

时间衰减主要影响语义物体，而不是占据栅格地图。观察方法：

1. **停止rosbag播放**
2. **观察地图是否保持稳定**
   - 占据栅格地图不应该立即消失
   - 应该保持当前状态较长时间

3. **重新播放rosbag**
   - 地图应该从上次状态继续更新
   - 不应该重新从空白开始

**预期行为**:
- 停止播放后，地图保持显示（这是RViz的特性）
- 重新播放后，地图继续更新
- 已知的障碍物和自由空间保持不变

## RViz操作技巧

### 调整Occupancy Grid显示

如果Occupancy Grid显示不清晰，可以调整以下参数：

1. **调整透明度（Alpha值）**
   - 在左侧面板找到"Occupancy Grid"
   - 找到"Alpha"参数
   - 调整到0.7-0.9之间
   - 值越大，颜色越不透明

2. **调整颜色方案**
   - 找到"Color Scheme"
   - 选择"map"（标准占据地图）
   - 或选择其他方案进行对比

3. **调整更新频率**
   - 如果地图闪烁，调整RViz的"Frame Rate"
   - 在菜单栏选择"Panels" -> "Views" -> "Frame Rate"
   - 降到10-20fps

### 视图调整

1. **旋转视图**
   - 鼠标左键拖动

2. **平移视图**
   - 鼠标中键拖动

3. **缩放视图**
   - 鼠标滚轮

4. **聚焦物体**
   - 双击3D视图中的物体

5. **保存视图**
   - 调整好视图后
   - 点击左上角"Views" -> "Current View"
   - 点击"Save"
   - 保存一个命名的视图

### 显示面板开关

在左侧"Displays"面板中，可以：
- 勾选/取消勾选来显示/隐藏某个面板
- 调整面板的显示顺序（拖动）
- 展开每个面板查看详细配置

### 调整3D点云

如果点云显示卡顿：
1. 找到"Point Cloud"面板
2. 调整"Size (m)"到0.03（更小的点）
3. 或调整"Size (Pixels)"到2

## 故障排查

### 问题1: Occupancy Grid面板全灰（无地图显示）

**可能原因**:
1. `/map`话题未发布
2. OccupancyMapper未启用
3. 话题名称不匹配

**检查方法**:
```bash
# 查看当前发布的话题
ros2 topic list

# 查看/map话题详细信息
ros2 topic info /map

# 查看/map话题的数据
ros2 topic echo /map --once
```

**解决方案**:
- 检查Brain系统是否正确启动
- 检查`ros2_interface.py`是否正确发布了`/map`话题
- 确认话题名称与RViz配置一致

### 问题2: Point Cloud不显示

**可能原因**:
1. 点云数据量过大
2. 话题名称不匹配
3. TF坐标系问题

**检查方法**:
```bash
# 查看点云话题
ros2 topic list | grep lidar

# 查看点云数据频率
ros2 topic hz /front_3d_lidar/lidar_points
```

**解决方案**:
- 检查话题名称是否正确
- 调整点云大小（Size参数）
- 检查TF树是否完整

### 问题3: RGB Camera图像不显示

**可能原因**:
1. 图像话题未发布
2. 图像面板未选中
3. 图像数据格式问题

**解决方案**:
- 检查`/front_stereo_camera/left/image_raw`话题是否存在
- 点击RViz窗口下方的"RGB Camera"标签
- 确认图像传输格式（raw, compressed等）

### 问题4: RViz启动失败

**可能原因**:
1. RViz2未安装
2. 配置文件损坏
3. ROS2环境问题

**解决方案**:
```bash
# 检查RViz2是否安装
which rviz2

# 安装RViz2（根据ROS2版本调整）
sudo apt install ros-humble-rviz2

# 检查ROS2环境
printenv | grep ROS
```

### 问题5: 地图更新不流畅

**可能原因**:
1. 电脑性能不足
2. 地图分辨率过高
3. 更新频率过高

**解决方案**:
- 调整RViz的Frame Rate（降到15-20fps）
- 增加Occupancy Grid的透明度（提高渲染效率）
- 关闭不必要的显示面板（如Laser Scan）

## 验证清单

在完成所有观察后，对照以下清单确认：

### 占据地图持久化
- [ ] 障碍物在多次扫描后保持稳定（黑色）
- [ ] 自由空间从机器人位置向外逐渐扩展（白色）
- [ ] 已探索区域不退回到未知状态（灰色）
- [ ] 贝叶斯更新生效（一次自由观测不立即占据）

### 语义物体持久化（如果适用）
- [ ] 同一物体的update_count持续递增
- [ ] 物体confidence随观测次数提升
- [ ] 长时间未观测时confidence按指数下降

### 时间衰减机制（如果适用）
- [ ] 停止rosbag后，地图保持显示
- [ ] 重新播放rosbag后，地图继续更新
- [ ] 已知状态保持不变

### 数据质量和性能
- [ ] Point Cloud显示流畅
- [ ] RGB Camera图像清晰
- [ ] Occupancy Grid更新稳定
- [ ] 所有面板都有数据显示
- [ ] TF坐标系树完整且正确

### 总体评估
- [ ] 世界模型持久化机制正常工作
- [ ] 贝叶斯更新机制正确实现
- [ ] 地图更新稳定可靠
- [ ] RViz显示清晰易读

## 高级验证

### 验证点云到占据地图的映射

**目标**: 确认点云数据正确转换为占据栅格地图

**方法**:
1. 在RViz中同时显示Point Cloud和Occupancy Grid
2. 观察点云中的障碍物是否对应地图中的黑色区域
3. 验证空间对应关系

### 验证机器人轨迹与地图更新

**目标**: 确认机器人移动与地图扩展的一致性

**方法**:
1. 观察Robot Path轨迹
2. 对比Occupancy Grid的扩展方向
3. 验证地图扩展是否沿轨迹方向进行

### 验证TF坐标系

**目标**: 确认所有坐标系正确对齐

**方法**:
1. 在RViz中显示TF面板
2. 检查odom -> base_link的变换
3. 检查base_link -> lidar_link的变换
4. 验证点云和地图的空间一致性

## 性能优化建议

### 如果RViz运行缓慢

1. **降低点云大小**
   - Point Cloud -> Size (m): 0.05 → 0.03
   - Size (Pixels): 3 → 2

2. **降低Frame Rate**
   - RViz -> Views -> Frame Rate: 30 → 15

3. **关闭不必要的面板**
   - 暂时关闭Laser Scan（如果不需要）
   - 暂时关闭Robot Path（如果不需要）

4. **减少Occupancy Grid的透明度**
   - Alpha: 0.7 → 0.9

### 如果地图显示不清晰

1. **调整对比度**
   - 可以通过调整Occupancy Grid的Alpha值

2. **缩放视图**
   - 使用鼠标滚轮放大地图
   - 关注局部细节

3. **保存多个视图**
   - 保存一个全局视图（overview）
   - 保存一个局部放大视图（detail）
   - 快速切换查看

## 总结

使用RViz验证世界模型的持久化机制是最直观和可靠的方法。通过观察Occupancy Grid面板，你可以：

1. **直观地看到**障碍物和自由空间的变化
2. **实时地验证**持久化机制是否正确工作
3. **定量地评估**贝叶斯更新和时间衰减的效果

配合`verify_world_model_rviz.py`脚本提供的统计信息，你可以全面地验证世界模型的各个方面。

如果在验证过程中发现任何问题，请参考"故障排查"部分，或查看Brain系统的日志输出。



