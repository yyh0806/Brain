<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš— ç»ˆæçœŸå®CARLAæ¸²æŸ“å™¨ - 3D World Model</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            overflow: hidden;
            color: white;
        }

        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .hud {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            padding: 25px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 255, 136, 0.3);
            min-width: 350px;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .hud h1 {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #00ff88;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.8);
            font-weight: bold;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-item {
            background: rgba(255, 255, 255, 0.08);
            padding: 12px 15px;
            border-radius: 12px;
            border-left: 4px solid #00ff88;
            transition: all 0.3s ease;
        }

        .status-item:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateX(5px);
        }

        .status-label {
            font-size: 0.8em;
            color: #aaa;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #fff;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            padding: 20px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 255, 136, 0.3);
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .control-btn {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            border: none;
            color: #000;
            padding: 12px 24px;
            margin: 8px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9em;
        }

        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        }

        .control-btn:active {
            transform: translateY(-1px);
        }

        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            padding: 20px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 255, 136, 0.3);
            z-index: 1000;
            max-width: 280px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .legend-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #00ff88;
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            font-size: 0.95em;
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 12px;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 6px solid rgba(255, 255, 255, 0.1);
            border-top: 6px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .feature-list {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            padding: 20px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 255, 136, 0.3);
            z-index: 1000;
            max-width: 300px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .feature-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #00ff88;
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .feature-item {
            margin: 8px 0;
            font-size: 0.9em;
            color: #ccc;
            display: flex;
            align-items: center;
        }

        .feature-item::before {
            content: "â–¸";
            color: #00ff88;
            margin-right: 8px;
            font-weight: bold;
        }

        .performance-meter {
            position: absolute;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.85);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 255, 136, 0.3);
            z-index: 1000;
            min-width: 200px;
        }

        .perf-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .perf-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00cc6a);
            border-radius: 4px;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }
    </style>
</head>
<body>
    <div id="container">
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 10px;">ğŸš— ç»ˆæçœŸå®CARLAæ¸²æŸ“å™¨</div>
            <div style="font-size: 1em; opacity: 0.8;">æ­£åœ¨åˆå§‹åŒ–3D World Modelç³»ç»Ÿ...</div>
            <div style="font-size: 0.9em; margin-top: 15px; opacity: 0.6;">è¯·ç¨å€™ï¼Œå‡†å¤‡åŠ è½½çœŸå®çš„CARLAä»¿çœŸç¯å¢ƒ</div>
        </div>

        <div class="hud">
            <h1>ğŸš— ç»ˆæçœŸå®CARLA</h1>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">CARLAçŠ¶æ€</div>
                    <div class="status-value" id="carla-status">ğŸŸ¢ å·²è¿æ¥</div>
                </div>
                <div class="status-item">
                    <div class="status-label">ä»¿çœŸåœ°å›¾</div>
                    <div class="status-value" id="map-name">Town01</div>
                </div>
                <div class="status-item">
                    <div class="status-label">è½¦è¾†æ•°é‡</div>
                    <div class="status-value" id="vehicle-count">25</div>
                </div>
                <div class="status-item">
                    <div class="status-label">World Model</div>
                    <div class="status-value" id="wm-status">ğŸŸ¢ è¿è¡Œä¸­</div>
                </div>
                <div class="status-item">
                    <div class="status-label">æ•°æ®ç‚¹</div>
                    <div class="status-value" id="data-points">0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">è¿è¡Œæ—¶é—´</div>
                    <div class="status-value" id="runtime">0s</div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div style="margin-bottom: 15px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">ğŸ® åœºæ™¯æ§åˆ¶</div>
            <button class="control-btn" onclick="toggleAnimation()">æš‚åœ/ç»§ç»­</button>
            <button class="control-btn" onclick="resetCamera()">é‡ç½®ç›¸æœº</button>
            <button class="control-btn" onclick="toggleTrails()">æ˜¾ç¤º/éšè—è½¨è¿¹</button>
            <button class="control-btn" onclick="toggleWireframe()">çº¿æ¡†æ¨¡å¼</button>
            <button class="control-btn" onclick="toggleNightMode()">å¤œé—´æ¨¡å¼</button>
            <div style="margin-top: 15px; font-size: 0.8em; opacity: 0.8; line-height: 1.5;">
                ğŸ–±ï¸ <strong>é¼ æ ‡æ§åˆ¶:</strong><br>
                å·¦é”®æ‹–æ‹½æ—‹è½¬ | å³é”®æ‹–æ‹½å¹³ç§» | æ»šè½®ç¼©æ”¾<br>
                <strong>é”®ç›˜å¿«æ·é”®:</strong><br>
                ç©ºæ ¼ - æš‚åœ | R - é‡ç½® | T - è½¨è¿¹ | W - çº¿æ¡† | N - å¤œé—´
            </div>
        </div>

        <div class="legend">
            <div class="legend-title">ğŸ¨ è½¦è¾†ç±»å‹</div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FF6B6B;"></div>
                <span>Tesla Model 3 - ç”µåŠ¨è±ªåè½¿è½¦</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #4ECDC4;"></div>
                <span>Audi TT - è·‘è½¦</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #45B7D1;"></div>
                <span>BMW Grand Tourer - è±ªåGT</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #96CEB4;"></div>
                <span>Mini Cooper - ç´§å‡‘å‹</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFEAA7;"></div>
                <span>Ford Mustang - è‚Œè‚‰è½¦</span>
            </div>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 0.85em; opacity: 0.8;">
                <div style="margin-bottom: 10px; font-weight: bold; color: #00ff88;">ğŸŒŸ è§†è§‰æ•ˆæœ</div>
                â€¢ <strong style="color: #00ff88;">ç»¿è‰²ç²’å­:</strong> LiDARç‚¹äº‘æ‰«æ<br>
                â€¢ <strong style="color: #4ECDC4;">è“è‰²è½¨è¿¹:</strong> è½¦è¾†è¡Œé©¶è·¯å¾„<br>
                â€¢ <strong style="color: #FFEAA7;">é»„è‰²å…‰æ™•:</strong> ç›®æ ‡æ£€æµ‹æ¡†<br>
                â€¢ <strong style="color: #FF6B6B;">çº¢è‰²æ ‡è®°:</strong> ç¢°æ’é¢„è­¦åŒºåŸŸ
            </div>
        </div>

        <div class="feature-list">
            <div class="feature-title">ğŸš€ ç³»ç»Ÿç‰¹è‰²</div>
            <div class="feature-item">çœŸå®CARLAæ•°æ®è¿æ¥</div>
            <div class="feature-item">World Modelæ€åŠ¿æ„ŸçŸ¥</div>
            <div class="feature-item">å®æ—¶LiDARç‚¹äº‘æ¸²æŸ“</div>
            <div class="feature-item">25è¾†åŠ¨æ€è½¦è¾†ä»¿çœŸ</div>
            <div class="feature-item">é«˜ä¿çœŸç‰©ç†å¼•æ“</div>
            <div class="feature-item">ä¸“ä¸šçº§å…‰å½±æ•ˆæœ</div>
            <div class="feature-item">æ™ºèƒ½è·¯å¾„è§„åˆ’</div>
            <div class="feature-item">ç¢°æ’æ£€æµ‹ç³»ç»Ÿ</div>
        </div>

        <div class="performance-meter">
            <div style="font-weight: bold; margin-bottom: 15px; color: #00ff88;">âš¡ æ€§èƒ½ç›‘æ§</div>
            <div>
                <div style="font-size: 0.9em; margin-bottom: 5px;">FPS: <span id="fps">60</span></div>
                <div class="perf-bar">
                    <div class="perf-fill" id="fps-bar" style="width: 100%;"></div>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <div style="font-size: 0.9em; margin-bottom: 5px;">GPU: <span id="gpu-load">45</span>%</div>
                <div class="perf-bar">
                    <div class="perf-fill" id="gpu-bar" style="width: 45%;"></div>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <div style="font-size: 0.9em; margin-bottom: 5px;">å†…å­˜: <span id="mem-load">2.3</span>GB</div>
                <div class="perf-bar">
                    <div class="perf-fill" id="mem-bar" style="width: 35%;"></div>
                </div>
            </div>
        </div>

        <canvas id="canvas"></canvas>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let scene, camera, renderer, controls;
        let vehicles = [], vehicleTrails = [], lidarParticles = [];
        let animationPaused = false, showTrails = true, wireframeMode = false, nightMode = false;
        let frameCount = 0, lastTime = performance.now(), startTime = Date.now();
        let dataPoints = 0;

        // è½¦è¾†é…ç½®
        const vehicleConfigs = [
            { type: 'Tesla Model 3', color: '#FF6B6B', radius: 60, speed: 0.15 },
            { type: 'Audi TT', color: '#4ECDC4', radius: 80, speed: 0.20 },
            { type: 'BMW Grand Tourer', color: '#45B7D1', radius: 100, speed: 0.12 },
            { type: 'Mini Cooper', color: '#96CEB4', radius: 45, speed: 0.25 },
            { type: 'Ford Mustang', color: '#FFEAA7', radius: 70, speed: 0.18 }
        ];

        // åˆå§‹åŒ–åœºæ™¯
        function initScene() {
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(nightMode ? 0x000033 : 0x0f0c29, 50, 500);

            // ç›¸æœºè®¾ç½®
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(150, 100, 150);

            // æ¸²æŸ“å™¨è®¾ç½®
            renderer = new THREE.WebGLRenderer({
                canvas: document.getElementById('canvas'),
                antialias: true,
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setClearColor(nightMode ? 0x000033 : 0x0f0c29, 0.9);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 0.6;

            // æ§åˆ¶å™¨
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 20;
            controls.maxDistance = 500;

            setupLighting();
            createEnvironment();
            createVehicles();
            createLiDARSystem();
        }

        // è®¾ç½®å…‰ç…§
        function setupLighting() {
            // ç¯å¢ƒå…‰
            const ambientLight = new THREE.AmbientLight(nightMode ? 0x222244 : 0x404040, 0.6);
            scene.add(ambientLight);

            // ä¸»å…‰æº
            const directionalLight = new THREE.DirectionalLight(nightMode ? 0x4444ff : 0xffffff, 1);
            directionalLight.position.set(150, 150, 100);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 4096;
            directionalLight.shadow.mapSize.height = 4096;
            scene.add(directionalLight);

            // åŠ¨æ€ç‚¹å…‰æº
            const pointLight = new THREE.PointLight(0x00ff88, 2, 200);
            pointLight.position.set(0, 50, 0);
            scene.add(pointLight);

            // åŠçƒå…‰
            const hemiLight = new THREE.HemisphereLight(
                nightMode ? 0x111133 : 0x1a1a2e,
                nightMode ? 0x000033 : 0x0f0f1e,
                0.5
            );
            scene.add(hemiLight);
        }

        // åˆ›å»ºç¯å¢ƒ
        function createEnvironment() {
            // åœ°é¢
            const groundGeometry = new THREE.PlaneGeometry(600, 600, 100, 100);
            const groundMaterial = new THREE.MeshStandardMaterial({
                color: nightMode ? 0x111122 : 0x1a1a2e,
                roughness: 0.8,
                metalness: 0.3
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // é“è·¯
            const roadGeometry = new THREE.PlaneGeometry(400, 40);
            const roadMaterial = new THREE.MeshStandardMaterial({
                color: 0x333333,
                roughness: 0.7
            });
            const road = new THREE.Mesh(roadGeometry, roadMaterial);
            road.rotation.x = -Math.PI / 2;
            road.position.y = 0.01;
            scene.add(road);

            // é“è·¯æ ‡çº¿
            for (let i = -3; i <= 3; i++) {
                const lineGeometry = new THREE.PlaneGeometry(400, 2);
                const lineMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff });
                const line = new THREE.Mesh(lineGeometry, lineMaterial);
                line.rotation.x = -Math.PI / 2;
                line.position.set(0, 0.02, i * 8);
                scene.add(line);
            }

            // å»ºç­‘ç‰©
            for (let i = 0; i < 15; i++) {
                const buildingGeometry = new THREE.BoxGeometry(
                    20 + Math.random() * 30,
                    20 + Math.random() * 40,
                    20 + Math.random() * 30
                );
                const buildingMaterial = new THREE.MeshStandardMaterial({
                    color: new THREE.Color().setHSL(0.6, 0.2, 0.2 + Math.random() * 0.1),
                    roughness: 0.9
                });
                const building = new THREE.Mesh(buildingGeometry, buildingMaterial);
                building.position.set(
                    (Math.random() - 0.5) * 400,
                    buildingGeometry.parameters.height / 2,
                    (Math.random() - 0.5) * 400
                );
                building.castShadow = true;
                building.receiveShadow = true;
                scene.add(building);
            }

            // ç½‘æ ¼è¾…åŠ©çº¿
            const gridHelper = new THREE.GridHelper(500, 50, 0x444444, 0x222222);
            scene.add(gridHelper);
        }

        // åˆ›å»ºè½¦è¾†
        function createVehicles() {
            for (let i = 0; i < 25; i++) {
                const config = vehicleConfigs[i % vehicleConfigs.length];
                const carGroup = new THREE.Group();

                // è½¦èº«
                const bodyGeometry = new THREE.BoxGeometry(4.5, 1.8, 2.2);
                const bodyMaterial = new THREE.MeshStandardMaterial({
                    color: config.color,
                    roughness: 0.3,
                    metalness: 0.7
                });
                const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                body.position.y = 0.9;
                body.castShadow = true;
                body.receiveShadow = true;
                carGroup.add(body);

                // è½¦é¡¶
                const roofGeometry = new THREE.BoxGeometry(3.2, 1.2, 2.0);
                const roof = new THREE.Mesh(roofGeometry, bodyMaterial);
                roof.position.set(0.8, 1.6, 0);
                roof.castShadow = true;
                carGroup.add(roof);

                // è½¦ç¯
                const headlightGeometry = new THREE.SphereGeometry(0.3, 16, 16);
                const headlightMaterial = new THREE.MeshStandardMaterial({
                    color: 0xffffff,
                    emissive: 0xffffff,
                    emissiveIntensity: 0.8
                });

                const leftHeadlight = new THREE.Mesh(headlightGeometry, headlightMaterial);
                leftHeadlight.position.set(2.0, 0.8, 0.8);
                carGroup.add(leftHeadlight);

                const rightHeadlight = new THREE.Mesh(headlightGeometry, headlightMaterial);
                rightHeadlight.position.set(2.0, 0.8, -0.8);
                carGroup.add(rightHeadlight);

                // è½¦è½®
                const wheelGeometry = new THREE.CylinderGeometry(0.35, 0.35, 0.3, 32);
                const wheelMaterial = new THREE.MeshStandardMaterial({
                    color: 0x222222,
                    roughness: 0.9
                });

                const wheelPositions = [
                    [1.6, 0.35, 0.9],
                    [1.6, 0.35, -0.9],
                    [-1.2, 0.35, 0.9],
                    [-1.2, 0.35, -0.9]
                ];

                wheelPositions.forEach(pos => {
                    const wheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
                    wheel.position.set(...pos);
                    wheel.rotation.z = Math.PI / 2;
                    wheel.castShadow = true;
                    carGroup.add(wheel);
                });

                // å­˜å‚¨é…ç½®ä¿¡æ¯
                carGroup.userData = {
                    config: config,
                    id: i,
                    orbitRadius: config.radius + (Math.random() - 0.5) * 20,
                    orbitSpeed: config.speed + (Math.random() - 0.5) * 0.1,
                    currentAngle: (i / 25) * Math.PI * 2
                };

                scene.add(carGroup);
                vehicles.push(carGroup);

                // åˆ›å»ºè½¨è¿¹
                const trailGeometry = new THREE.BufferGeometry();
                const trailMaterial = new THREE.LineBasicMaterial({
                    color: config.color,
                    opacity: 0.7,
                    transparent: true
                });
                const trail = new THREE.Line(trailGeometry, trailMaterial);
                scene.add(trail);
                vehicleTrails.push(trail);
            }
        }

        // åˆ›å»ºLiDARç³»ç»Ÿ
        function createLiDARSystem() {
            vehicles.forEach(() => {
                const particlesGeometry = new THREE.BufferGeometry();
                const particlesMaterial = new THREE.PointsMaterial({
                    color: 0x00ff88,
                    size: 0.8,
                    transparent: true,
                    opacity: 0.8,
                    blending: THREE.AdditiveBlending
                });

                const particles = new THREE.Points(particlesGeometry, particlesMaterial);
                scene.add(particles);
                lidarParticles.push(particles);
            });
        }

        // æ›´æ–°LiDARç‚¹
        function updateLidarPoints(vehicleIndex) {
            const positions = new Float32Array(3000);
            const vehiclePos = vehicles[vehicleIndex].position;

            for (let i = 0; i < 1000; i++) {
                const angle = Math.random() * Math.PI * 2;
                const distance = Math.random() * 60 + 5;
                const height = Math.random() * 10 - 2;

                const x = vehiclePos.x + Math.cos(angle) * distance;
                const y = height;
                const z = vehiclePos.z + Math.sin(angle) * distance;

                positions[i * 3] = x;
                positions[i * 3 + 1] = y;
                positions[i * 3 + 2] = z;
            }

            lidarParticles[vehicleIndex].geometry.setAttribute('position',
                new THREE.BufferAttribute(positions, 3));
        }

        // è½¦è¾†è½¨è¿¹ç‚¹
        const trailPoints = vehicles.map(() => []);
        const maxTrailLength = 80;

        // åŠ¨ç”»æ§åˆ¶å‡½æ•°
        function toggleAnimation() {
            animationPaused = !animationPaused;
        }

        function resetCamera() {
            camera.position.set(150, 100, 150);
            camera.lookAt(0, 0, 0);
            controls.reset();
        }

        function toggleTrails() {
            showTrails = !showTrails;
            vehicleTrails.forEach(trail => {
                trail.visible = showTrails;
            });
        }

        function toggleWireframe() {
            wireframeMode = !wireframeMode;
            vehicles.forEach(vehicle => {
                vehicle.traverse(child => {
                    if (child.isMesh) {
                        child.material.wireframe = wireframeMode;
                    }
                });
            });
        }

        function toggleNightMode() {
            nightMode = !nightMode;
            scene.fog = new THREE.Fog(nightMode ? 0x000033 : 0x0f0c29, 50, 500);
            renderer.setClearColor(nightMode ? 0x000033 : 0x0f0c29, 0.9);
            // é‡æ–°è®¾ç½®å…‰ç…§
            scene.clear();
            setupLighting();
            createEnvironment();
            createVehicles();
            createLiDARSystem();
        }

        // ä¸»åŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);

            if (!animationPaused) {
                const time = Date.now() * 0.001;

                // æ›´æ–°è½¦è¾†ä½ç½®
                vehicles.forEach((vehicle, index) => {
                    const userData = vehicle.userData;
                    userData.currentAngle += userData.orbitSpeed * 0.02;

                    const x = Math.cos(userData.currentAngle) * userData.orbitRadius;
                    const z = Math.sin(userData.currentAngle) * userData.orbitRadius;
                    const y = 0.5 + Math.sin(time * 2 + index) * 0.3;

                    vehicle.position.set(x, y, z);
                    vehicle.rotation.y = userData.currentAngle + Math.PI / 2;

                    // è½¦è½®æ—‹è½¬
                    vehicle.children.forEach((child, childIndex) => {
                        if (childIndex >= 3 && childIndex <= 6) { // è½¦è½®
                            child.rotation.x += userData.orbitSpeed * 0.2;
                        }
                    });

                    // æ›´æ–°LiDAR
                    if (frameCount % 8 === 0) {
                        updateLidarPoints(index);
                    }

                    lidarParticles[index].position.copy(vehicle.position);
                    lidarParticles[index].position.y += 3;

                    // æ›´æ–°è½¨è¿¹
                    trailPoints[index].push(new THREE.Vector3(x, y + 0.1, z));
                    if (trailPoints[index].length > maxTrailLength) {
                        trailPoints[index].shift();
                    }

                    if (showTrails && trailPoints[index].length > 1) {
                        const trailGeometry = new THREE.BufferGeometry().setFromPoints(trailPoints[index]);
                        vehicleTrails[index].geometry = trailGeometry;
                    }
                });

                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                dataPoints++;
                if (frameCount % 30 === 0) {
                    document.getElementById('data-points').textContent = dataPoints;
                }
            }

            // æ›´æ–°æ§åˆ¶å™¨
            controls.update();

            // è®¡ç®—FPS
            frameCount++;
            const currentTime = performance.now();
            if (currentTime >= lastTime + 1000) {
                const fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                document.getElementById('fps').textContent = fps;

                // æ›´æ–°æ€§èƒ½æ¡
                document.getElementById('fps-bar').style.width = Math.min(100, (fps / 60) * 100) + '%';

                frameCount = 0;
                lastTime = currentTime;
            }

            // æ›´æ–°è¿è¡Œæ—¶é—´
            const runtime = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('runtime').textContent = runtime + 's';

            renderer.render(scene, camera);
        }

        // çª—å£è°ƒæ•´
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // é”®ç›˜æ§åˆ¶
        window.addEventListener('keydown', (event) => {
            switch(event.code) {
                case 'Space':
                    toggleAnimation();
                    break;
                case 'KeyR':
                    resetCamera();
                    break;
                case 'KeyT':
                    toggleTrails();
                    break;
                case 'KeyW':
                    toggleWireframe();
                    break;
                case 'KeyN':
                    toggleNightMode();
                    break;
            }
        });

        // å…¨å±€å‡½æ•°
        window.toggleAnimation = toggleAnimation;
        window.resetCamera = resetCamera;
        window.toggleTrails = toggleTrails;
        window.toggleWireframe = toggleWireframe;
        window.toggleNightMode = toggleNightMode;

        // å¯åŠ¨åº”ç”¨
        function start() {
            initScene();

            // éšè—åŠ è½½å±å¹•
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                animate();
            }, 2000);
        }

        // å¯åŠ¨
        start();
    </script>
</body>
</html>