version: '3.8'

services:
  isaac-sim-brain:
    build:
      context: .
      dockerfile: Dockerfile.isaac_sim
    container_name: brain-isaac-sim
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,graphics
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - XDG_RUNTIME_DIR=/tmp
      - PULSE_SERVER=unix:${XDG_RUNTIME_DIR}/pulse/native
      - PYTHONPATH=/workspace/brain
      - ROS_DOMAIN_ID=1
    volumes:
      # 挂载Brain项目代码
      - ./:/workspace/brain:rw
      # 挂载X11显示
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      # 挂载数据和配置
      - ./data:/workspace/data:rw
      - ./logs:/workspace/logs:rw
      - ./config:/workspace/config:rw
      - ./outputs:/workspace/outputs:rw
      # 挂载D-Bus for Wayland支持
      - ${XDG_RUNTIME_DIR}/pulse:${XDG_RUNTIME_DIR}/pulse:ro
      # 挂载Isaac Sim许可证（如果有）
      - ~/.nv:/root/.nv:ro
    ports:
      - "8888:8888"    # Jupyter Lab
      - "8080:8080"    # Streamlit Dashboard
      - "49000-49010:49000-49010"  # Isaac Sim Web服务
    network_mode: host
    privileged: true
    stdin_open: true
    tty: true
    command: /bin/bash

  jupyter-lab:
    build:
      context: .
      dockerfile: Dockerfile.isaac_sim
    container_name: brain-jupyter
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - PYTHONPATH=/workspace/brain
      - JUPYTER_ENABLE_LAB=yes
      - JUPYTER_TOKEN=brain2024
    volumes:
      - ./:/workspace/brain:rw
      - ./data:/workspace/data:rw
      - ./logs:/workspace/logs:rw
      - ./outputs:/workspace/outputs:rw
    ports:
      - "8889:8888"
    command: jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root --NotebookApp.token='brain2024'

  streamlit-dashboard:
    build:
      context: .
      dockerfile: Dockerfile.isaac_sim
    container_name: brain-dashboard
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - PYTHONPATH=/workspace/brain
    volumes:
      - ./:/workspace/brain:rw
      - ./data:/workspace/data:rw
      - ./logs:/workspace/logs:rw
      - ./config:/workspace/config:rw
    ports:
      - "8501:8501"
    command: streamlit run world_model_dashboard/streamlit_dashboard.py --server.address=0.0.0.0 --server.port=8501