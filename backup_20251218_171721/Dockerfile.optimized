# ä¼˜åŒ–çš„BRAIN Isaac Sim Dockeré•œåƒ
# å¤šé˜¶æ®µæ„å»º + å±‚ç¼“å­˜ä¼˜åŒ–
FROM python:3.9-slim as base

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# å®‰è£…ç³»ç»Ÿä¾èµ– (ä½¿ç”¨APTç¼“å­˜ä¼˜åŒ–)
RUN --mount=type=cache,target=/var/cache/apt \
    --mount=type=cache,target=/var/lib/apt \
    apt-get update && apt-get install -y \
    # åŸºç¡€ä¾èµ–
    python3-pip \
    python3-dev \
    build-essential \
    # å¼€å‘å·¥å…·
    git \
    wget \
    curl \
    vim \
    # ç§‘å­¦è®¡ç®—ä¾èµ–
    libgl1-mesa-dev \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    # æ¸…ç†
    && apt-get autoremove -y \
    && apt-get clean -y \
    && rm -rf /var/lib/apt/lists/*

# å‡çº§pip
RUN python3 -m pip install --upgrade pip setuptools wheel

# =========== ä¾èµ–å®‰è£…é˜¶æ®µ ===========
FROM base as dependencies

# å®‰è£…æ ¸å¿ƒPythonä¾èµ– (ä½¿ç”¨pip cache)
RUN --mount=type=cache,target=/root/.cache/pip \
    pip3 install \
    # æ ¸å¿ƒæ¡†æ¶
    pydantic==2.10.6 \
    python-dotenv==1.0.1 \
    pyyaml==6.0.3 \
    loguru==0.7.3 \
    # ç§‘å­¦è®¡ç®—
    numpy==1.24.4 \
    # æœºå™¨å­¦ä¹  (è½»é‡çº§)
    scikit-learn==1.3.2 \
    # Webæ¡†æ¶
    streamlit==1.40.1 \
    # å¼€å‘ç¯å¢ƒ
    jupyterlab==4.3.8

# å®‰è£…ä»¿çœŸå’Œè§†è§‰ä¾èµ–
RUN --mount=type=cache,target=/root/.cache/pip \
    pip3 install \
    # ç‰©ç†ä»¿çœŸ
    pygame==2.6.1 \
    pybullet==3.2.7 \
    # è®¡ç®—æœºè§†è§‰
    opencv-python==4.12.0.88 \
    # æ•°æ®å¯è§†åŒ–
    plotly==5.20.0 \
    matplotlib==3.7.5 \
    # æ•°æ®å¤„ç†
    pandas==2.0.3

# =========== è¿è¡Œæ—¶é˜¶æ®µ ===========
FROM dependencies as runtime

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /workspace/brain

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶ (ä¼˜åŒ–COPYé¡ºåºï¼Œå°‘å˜åŒ–çš„æ–‡ä»¶ä¼˜å…ˆ)
COPY requirements*.txt ./
COPY brain/ brain/
COPY *.py ./

# å®‰è£…é¡¹ç›®ç‰¹å®šä¾èµ– (å¦‚æœå­˜åœ¨)
RUN if [ -f requirements.docker.txt ]; then \
        --mount=type=cache,target=/root/.cache/pip \
        pip3 install -r requirements.docker.txt; \
    fi

# åˆ›å»ºå¿…è¦ç›®å½•
RUN mkdir -p /workspace/data /workspace/logs /workspace/outputs /workspace/config

# è®¾ç½®Pythonè·¯å¾„
ENV PYTHONPATH="/workspace/brain:${PYTHONPATH}"

# åˆ›å»ºérootç”¨æˆ· (å®‰å…¨ä¼˜åŒ–)
RUN useradd -m -u 1000 brain && \
    chown -R brain:brain /workspace

USER brain

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python3 -c "import brain.cognitive.world_model; print('âœ… Health check passed')" || exit 1

# æš´éœ²ç«¯å£
EXPOSE 8888 8501

# å¯åŠ¨è„šæœ¬
COPY --chown=brain:brain <<EOF /entrypoint.sh
#!/bin/bash
set -e

echo "ğŸ§  BRAIN Isaac Sim Container Starting..."
echo "ğŸ“Š Python: \$(python3 --version)"
echo "ğŸ³ Docker Image: \$(cat /etc/os-release | grep PRETTY_NAME)"
echo "ğŸ¯ Working Directory: \$(pwd)"
echo "ğŸ”§ Python Path: \${PYTHONPATH}"

# åˆ‡æ¢åˆ°å·¥ä½œç›®å½•
cd /workspace/brain

# æ‰§è¡Œä¼ å…¥çš„å‘½ä»¤
exec "\$@"
EOF
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["python3", "run_complete_system_demo.py", "--mode", "quick"]

# =========== å¼€å‘ç‰ˆæœ¬ ===========
FROM runtime as development

# åˆ‡æ¢å›rootç”¨æˆ·å®‰è£…å¼€å‘ä¾èµ–
USER root

# å®‰è£…å¼€å‘å·¥å…·
RUN --mount=type=cache,target=/root/.cache/pip \
    pip3 install \
    pytest==7.4.4 \
    black==23.12.1 \
    flake8==6.1.0 \
    ipython==8.18.1 \
    notebook==7.1.0

# åˆ‡æ¢å›brainç”¨æˆ·
USER brain

# å¼€å‘æ¨¡å¼é»˜è®¤å‘½ä»¤
CMD ["jupyter", "lab", "--ip=0.0.0.0", "--port=8888", "--no-browser", "--allow-root", "--NotebookApp.token=brain2024"]