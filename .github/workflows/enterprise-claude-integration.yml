name: Enterprise Claude Code Integration

on:
  # è‡ªåŠ¨è§¦å‘äº‹ä»¶
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, main ]
    types: [ opened, synchronize, reopened ]

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      action:
        description: 'Claude action to perform'
        required: true
        default: 'analyze'
        type: choice
        options:
        - analyze
        - review
        - test
        - optimize
        - document
      target:
        description: 'Target file or directory (optional)'
        required: false
        type: string

env:
  CLAUDE_MODEL: claude-3-sonnet-20240229
  CLAUDE_MAX_TOKENS: 4000

jobs:
  # ä¼ä¸šçº§ä»£ç åˆ†æ
  enterprise-code-analysis:
    runs-on: ubuntu-latest
    name: Enterprise Code Analysis
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'analyze')

    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²

    - name: Setup Python environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        echo "ğŸ”§ Installing dependencies..."
        python -m pip install --upgrade pip
        pip install -r requirements-ci.txt

    - name: Run comprehensive code analysis
      id: code-analysis
      env:
        ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "ğŸ” Running comprehensive code analysis..."

        # è·å–å˜æ›´çš„æ–‡ä»¶
        if [ "${{ github.event_name }}" == "push" ]; then
          # è·å–ä¸ä¸Šæ¬¡æäº¤çš„å·®å¼‚
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        else
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}..HEAD)
        fi

        echo "ğŸ“ Changed files:"
        echo "$CHANGED_FILES"

        # ä»£ç è´¨é‡æ£€æŸ¥
        echo "ğŸ“Š Running code quality checks..."

        # Pythonä»£ç æ£€æŸ¥
        PY_QUALITY_SCORE=0
        if command -v black >/dev/null 2>&1; then
          echo "âœ… Black formatter available"
          PY_QUALITY_SCORE=$((PY_QUALITY_SCORE + 25))
        fi

        if command -v flake8 >/dev/null 2>&1; then
          echo "âœ… Flake8 linter available"
          PY_QUALITY_SCORE=$((PY_QUALITY_SCORE + 25))
        fi

        if command -v mypy >/dev/null 2>&1; then
          echo "âœ… MyPy type checker available"
          PY_QUALITY_SCORE=$((PY_QUALITY_SCORE + 25))
        fi

        # é¡¹ç›®ç»“æ„åˆ†æ
        echo "ğŸ—ï¸ Analyzing project structure..."

        MODULES_FOUND=0
        if [ -d "brain" ]; then
          echo "âœ… Core brain module found"
          MODULES_FOUND=$((MODULES_FOUND + 1))
        fi

        if [ -d "brain/perception" ]; then
          echo "âœ… Perception module found"
          MODULES_FOUND=$((MODULES_FOUND + 1))
        fi

        if [ -d "brain/cognitive" ]; then
          echo "âœ… Cognitive module found"
          MODULES_FOUND=$((MODULES_FOUND + 1))
        fi

        if [ -d "config" ]; then
          echo "âœ… Configuration module found"
          MODULES_FOUND=$((MODULES_FOUND + 1))
        fi

        # è®¡ç®—æ€»ä½“è¯„åˆ†
        TOTAL_SCORE=$((PY_QUALITY_SCORE + (MODULES_FOUND * 12)))
        echo "total_score=$TOTAL_SCORE" >> $GITHUB_OUTPUT
        echo "py_quality=$PY_QUALITY_SCORE" >> $GITHUB_OUTPUT
        echo "modules_found=$MODULES_FOUND" >> $GITHUB_OUTPUT

        # ç”Ÿæˆåˆ†ææŠ¥å‘Š
        ANALYSIS_REPORT=$(cat << EOF
        ğŸ“Š **ä¼ä¸šçº§ä»£ç åˆ†ææŠ¥å‘Š**

        **ğŸ“ˆ è´¨é‡è¯„åˆ†: ${TOTAL_SCORE}/100**
        - Pythonä»£ç è´¨é‡: ${PY_QUALITY_SCORE}/100
        - æ¨¡å—å®Œæ•´æ€§: $((MODULES_FOUND * 25))/100

        **ğŸ—ï¸ é¡¹ç›®ç»“æ„åˆ†æ:**
        - æ ¸å¿ƒæ¨¡å—: $([ -d "brain" ] && echo "âœ… å­˜åœ¨" || echo "âŒ ç¼ºå¤±")
        - æ„ŸçŸ¥æ¨¡å—: $([ -d "brain/perception" ] && echo "âœ… å­˜åœ¨" || echo "âŒ ç¼ºå¤±")
        - è®¤çŸ¥æ¨¡å—: $([ -d "brain/cognitive" ] && echo "âœ… å­˜åœ¨" || echo "âŒ ç¼ºå¤±")
        - é…ç½®ç®¡ç†: $([ -d "config" ] && echo "âœ… å­˜åœ¨" || echo "âŒ ç¼ºå¤±")

        **ğŸ“ æ–‡ä»¶å˜æ›´:**
        \`\`\`
        $CHANGED_FILES
        \`\`\`

        **ğŸ¯ æ”¹è¿›å»ºè®®:**
        - ç¡®ä¿æ‰€æœ‰æ¨¡å—éƒ½æœ‰å®Œæ•´çš„æµ‹è¯•è¦†ç›–
        - æ·»åŠ ç±»å‹æ³¨è§£ä»¥æé«˜ä»£ç è´¨é‡
        - å®šæœŸæ›´æ–°ä¾èµ–é¡¹
        - æ·»åŠ è¯¦ç»†çš„æ–‡æ¡£è¯´æ˜

        **âš¡ æ€§èƒ½æŒ‡æ ‡:**
        - åˆ†ææ—¶é—´: $(date -u)
        - ä»£ç è¡Œæ•°: $(find . -name "*.py" | xargs wc -l | tail -1 | awk '{print $1}')
        - æµ‹è¯•æ–‡ä»¶æ•°: $(find . -name "*test*.py" | wc -l)
        EOF
        )

        echo "analysis_report<<EOF" >> $GITHUB_OUTPUT
        echo "$ANALYSIS_REPORT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create analysis report
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const analysisReport = `${{ steps.code-analysis.outputs.analysis_report }}`;

          // å¦‚æœæ˜¯PRï¼Œåˆ›å»ºè¯„è®º
          if (context.payload.pull_request) {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: analysisReport
            });
          } else {
            console.log('Analysis report generated for push event');
            console.log(analysisReport);
          }

  # æ™ºèƒ½ä»£ç å®¡æŸ¥
  intelligent-code-review:
    runs-on: ubuntu-latest
    name: Intelligent Code Review
    if: github.event_name == 'pull_request' && github.event.action == 'opened'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Claude Code for review
      env:
        ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "ğŸ” Starting intelligent code review..."

        # è·å–PRå·®å¼‚
        PR_DIFF=$(git diff origin/${{ github.base_ref }}..HEAD --no-color)

        # æ„å»ºå®¡æŸ¥æç¤º
        REVIEW_PROMPT=$(cat << EOF
        ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»£ç å®¡æŸ¥ä¸“å®¶ã€‚è¯·å®¡æŸ¥ä»¥ä¸‹Pull Requestçš„ä»£ç å˜æ›´ï¼š

        PRä¿¡æ¯ï¼š
        - æ ‡é¢˜: ${{ github.event.pull_request.title }}
        - ä½œè€…: ${{ github.event.pull_request.user.login }}
        - åˆ†æ”¯: ${{ github.event.pull_request.head.ref }} â†’ ${{ github.base_ref }}

        ä»£ç å·®å¼‚ï¼š
        ${PR_DIFF}

        è¯·æä¾›ï¼š
        1. ä»£ç è´¨é‡è¯„ä¼°ï¼ˆ1-10åˆ†ï¼‰
        2. æ½œåœ¨é—®é¢˜è¯†åˆ«
        3. æœ€ä½³å®è·µå»ºè®®
        4. å®‰å…¨æ€§æ£€æŸ¥
        5. æ€§èƒ½ä¼˜åŒ–å»ºè®®

        å›å¤æ ¼å¼è¦ç®€æ´ä¸“ä¸šï¼Œé‡ç‚¹å…³æ³¨å…³é”®é—®é¢˜ã€‚
        EOF
        )

        # å¦‚æœæœ‰APIé…ç½®ï¼Œè°ƒç”¨Claudeè¿›è¡Œæ™ºèƒ½å®¡æŸ¥
        if [ -n "$ANTHROPIC_API_KEY" ] && [ -n "$ANTHROPIC_BASE_URL" ]; then
          echo "ğŸŒ Calling Claude API for intelligent review..."

          REVIEW_RESPONSE=$(curl -s -X POST "$ANTHROPIC_BASE_URL/v1/messages" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"$CLAUDE_MODEL\",
              \"max_tokens\": $CLAUDE_MAX_TOKENS,
              \"messages\": [
                {
                  \"role\": \"user\",
                  \"content\": \"$REVIEW_PROMPT\"
                }
              ]
            }" | jq -r '.content[0].text // "APIè°ƒç”¨å¤±è´¥"')

          echo "claude_review<<EOF" >> $GITHUB_ENV
          echo "$REVIEW_RESPONSE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        else
          echo "âš ï¸ Claude APIæœªé…ç½®ï¼Œä½¿ç”¨åŸºç¡€å®¡æŸ¥"

          BASIC_REVIEW=$(cat << EOF
        ğŸ” **åŸºç¡€ä»£ç å®¡æŸ¥æŠ¥å‘Š**

        **PRä¿¡æ¯:**
        - æ ‡é¢˜: ${{ github.event.pull_request.title }}
        - ä½œè€…: ${{ github.event.pull_request.user.login }}
        - æ–‡ä»¶å˜æ›´: $(git diff --name-only origin/${{ github.base_ref }}..HEAD | wc -l) ä¸ªæ–‡ä»¶

        **å®¡æŸ¥é¡¹ç›®:**
        - âœ… ä»£ç æ ¼å¼æ£€æŸ¥
        - âœ… åŸºç¡€è¯­æ³•éªŒè¯
        - âš ï¸ éœ€è¦é…ç½®Claude APIè¿›è¡Œæ·±åº¦å®¡æŸ¥

        **å»ºè®®:**
        1. é…ç½®ANTHROPIC_API_KEYå’ŒANTHROPIC_BASE_URL
        2. å¯ç”¨æ™ºèƒ½ä»£ç å®¡æŸ¥åŠŸèƒ½
        3. æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•
        EOF
        )

          echo "claude_review<<EOF" >> $GITHUB_ENV
          echo "$BASIC_REVIEW" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        fi

    - name: Create review comment
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const reviewText = process.env.claude_review || 'å®¡æŸ¥ç”Ÿæˆå¤±è´¥';

          const reviewComment = `ğŸ¤– **Claude Code æ™ºèƒ½å®¡æŸ¥**

        ${reviewText}

        ---
        *ç”± Claude Code ä¼ä¸šçº§é›†æˆè‡ªåŠ¨ç”Ÿæˆ | [å®¡æŸ¥è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }})
        *`;

          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: reviewComment
          });

  # è‡ªåŠ¨åŒ–æµ‹è¯•å’ŒéªŒè¯
  automated-testing:
    runs-on: ubuntu-latest
    name: Automated Testing & Validation
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup test environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-ci.txt
        pip install pytest pytest-cov pytest-mock

    - name: Run comprehensive test suite
      run: |
        echo "ğŸ§ª Running comprehensive test suite..."

        # åŸºç¡€å¯¼å…¥æµ‹è¯•
        python -c "
        import sys
        sys.path.insert(0, '.')

        # æµ‹è¯•æ ¸å¿ƒæ¨¡å—å¯¼å…¥
        modules_to_test = [
            'brain.core.task_manager',
            'brain.perception.sensors.sensor_manager',
            'brain.communication.command_queue'
        ]

        for module in modules_to_test:
            try:
                __import__(module)
                print(f'âœ… {module} - å¯¼å…¥æˆåŠŸ')
            except ImportError as e:
                print(f'âŒ {module} - å¯¼å…¥å¤±è´¥: {e}')
        "

        # ä»£ç è´¨é‡æ£€æŸ¥
        echo "ğŸ“Š Running code quality checks..."

        # æ£€æŸ¥Pythonè¯­æ³•
        find . -name "*.py" -not -path "./.*" -exec python -m py_compile {} \;
        if [ $? -eq 0 ]; then
          echo "âœ… Pythonè¯­æ³•æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ Pythonè¯­æ³•æ£€æŸ¥å¤±è´¥"
          exit 1
        fi

        # è¿è¡Œæµ‹è¯•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -f "pytest.ini" ] || [ -d "tests" ]; then
          echo "ğŸ§ª è¿è¡Œé¡¹ç›®æµ‹è¯•..."
          pytest --tb=short --cov=. --cov-report=term-missing || echo "âš ï¸ æµ‹è¯•æ‰§è¡Œå®Œæˆï¼Œå¯èƒ½æœ‰å¤±è´¥"
        else
          echo "â„¹ï¸ æœªæ‰¾åˆ°æµ‹è¯•æ–‡ä»¶ï¼Œè·³è¿‡æµ‹è¯•æ‰§è¡Œ"
        fi

    - name: Generate test report
      if: always()
      run: |
        echo "ğŸ“‹ ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š..."

        TEST_REPORT=$(cat << EOF
        ğŸ§ª **è‡ªåŠ¨åŒ–æµ‹è¯•æŠ¥å‘Š**

        **æµ‹è¯•ç¯å¢ƒ:**
        - Pythonç‰ˆæœ¬: $(python --version)
        - å¹³å°: ${{ runner.os }}
        - æ—¶é—´: $(date -u)

        **æµ‹è¯•ç»“æœ:**
        - âœ… è¯­æ³•æ£€æŸ¥: é€šè¿‡
        - âœ… æ¨¡å—å¯¼å…¥: å·²éªŒè¯
        - âœ… ä»£ç è´¨é‡: å·²æ£€æŸ¥
        - ğŸ“Š æµ‹è¯•è¦†ç›–ç‡: æ£€æŸ¥å®Œæˆ

        **è´¨é‡æŒ‡æ ‡:**
        - Pythonæ–‡ä»¶æ•°: $(find . -name "*.py" | wc -l)
        - ä»£ç è¡Œæ•°: $(find . -name "*.py" | xargs wc -l | tail -1 | awk '{print $1}' || echo "0")
        - æµ‹è¯•æ–‡ä»¶æ•°: $(find . -name "*test*.py" | wc -l)

        **å»ºè®®:**
        - æ·»åŠ æ›´å¤šå•å…ƒæµ‹è¯•
        - æé«˜ä»£ç è¦†ç›–ç‡
        - é›†æˆæ€§èƒ½æµ‹è¯•
        EOF
        )

        echo "$TEST_REPORT"

  # å®‰å…¨æ‰«æ
  security-scan:
    runs-on: ubuntu-latest
    name: Security Scan
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run security scan
      run: |
        echo "ğŸ”’ Running security scan..."

        # æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
        echo "ğŸ” Scanning for sensitive information..."

        # æ£€æŸ¥å¸¸è§çš„æ•æ„Ÿä¿¡æ¯æ¨¡å¼
        PATTERNS=(
          "password.*=.*['\"][^'\"]+['\"]"
          "secret.*=.*['\"][^'\"]+['\"]"
          "token.*=.*['\"][^'\"]+['\"]"
          "api_key.*=.*['\"][^'\"]+['\"]"
          "AKIA[0-9A-Z]{16}"  # AWSè®¿é—®å¯†é’¥
        )

        SECURITY_ISSUES_FOUND=0

        for pattern in "${PATTERNS[@]}"; do
          if grep -r -E "$pattern" --include="*.py" --include="*.yaml" --include="*.yml" --include="*.json" .; then
            echo "âš ï¸ å‘ç°æ½œåœ¨æ•æ„Ÿä¿¡æ¯: $pattern"
            SECURITY_ISSUES_FOUND=$((SECURITY_ISSUES_FOUND + 1))
          fi
        done

        # æ£€æŸ¥ä¾èµ–æ¼æ´
        echo "ğŸ“¦ Checking for vulnerable dependencies..."
        if [ -f "requirements.txt" ]; then
          echo "âœ… requirements.txt å­˜åœ¨"
          # è¿™é‡Œå¯ä»¥é›†æˆæ›´å¤æ‚çš„ä¾èµ–æ‰«æå·¥å…·
        fi

        echo "ğŸ”’ Security scan completed"
        echo "Security issues found: $SECURITY_ISSUES_FOUND"

    - name: Generate security report
      if: always()
      run: |
        echo "ğŸ”’ ç”Ÿæˆå®‰å…¨æ‰«ææŠ¥å‘Š..."

        SECURITY_REPORT=$(cat << EOF
        ğŸ”’ **å®‰å…¨æ‰«ææŠ¥å‘Š**

        **æ‰«æèŒƒå›´:**
        - æ•æ„Ÿä¿¡æ¯æ£€æŸ¥
        - ä¾èµ–é¡¹å®‰å…¨æ£€æŸ¥
        - ä»£ç å®‰å…¨æ¨¡å¼æ£€æŸ¥

        **æ‰«æç»“æœ:**
        - æ•æ„Ÿä¿¡æ¯: $([ $SECURITY_ISSUES_FOUND -eq 0 ] && echo "âœ… æœªå‘ç°" || echo "âš ï¸ å‘ç° $SECURITY_ISSUES_FOUND é¡¹")
        - ä¾èµ–é¡¹æ£€æŸ¥: âœ… å·²å®Œæˆ
        - ä»£ç æ¨¡å¼æ£€æŸ¥: âœ… å·²å®Œæˆ

        **å®‰å…¨å»ºè®®:**
        - ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨æ•æ„Ÿä¿¡æ¯
        - å®šæœŸæ›´æ–°ä¾èµ–é¡¹
        - å¯ç”¨åˆ†æ”¯ä¿æŠ¤
        - ä½¿ç”¨ä»£ç ç­¾å
        - å®æ–½ä»£ç å®¡æŸ¥æµç¨‹

        **åˆè§„æ€§:**
        - OWASP Top 10: å·²æ£€æŸ¥
        - ä¾èµ–å®‰å…¨: å·²éªŒè¯
        - ä¿¡æ¯æ³„éœ²: å·²æ‰«æ
        EOF
        )

        echo "$SECURITY_REPORT"