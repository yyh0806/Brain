name: Claude Assistant

on:
  issue_comment:
    types: [ created ]
  pull_request_review_comment:
    types: [ created ]
  pull_request:
    types: [ opened, synchronize, reopened ]
  issues:
    types: [ opened ]

jobs:
  # ClaudeæåŠå“åº”å™¨
  claude-mention-responder:
    runs-on: ubuntu-latest
    name: Claude Mention Responder
    if: contains(github.event.comment.body, '@claude') || contains(github.event.issue.body, '@claude')

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Claude Code
      run: |
        echo "ğŸ”§ Setting up Claude Code..."
        npm install -g @anthropic-ai/claude-code

    - name: Parse Claude command and context
      id: parse-command
      run: |
        # è·å–è¯„è®ºæˆ–Issueå†…å®¹
        if [ "${{ github.event.comment }}" != "" ]; then
          CONTENT="${{ github.event.comment.body }}"
          CONTEXT_TYPE="comment"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
        else
          CONTENT="${{ github.event.issue.body }}"
          CONTEXT_TYPE="issue"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
        fi

        echo "content=$CONTENT" >> $GITHUB_OUTPUT
        echo "context_type=$CONTEXT_TYPE" >> $GITHUB_OUTPUT
        echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

        # æå–@claudeåé¢çš„å‘½ä»¤
        COMMAND=$(echo "$CONTENT" | sed 's/.*@claude//' | xargs)
        echo "command=$COMMAND" >> $GITHUB_OUTPUT

        # æ£€æµ‹ç‰¹æ®Šå‘½ä»¤
        if [[ "$COMMAND" == *"help"* ]]; then
          echo "action=help" >> $GITHUB_OUTPUT
        elif [[ "$COMMAND" == *"status"* ]]; then
          echo "action=status" >> $GITHUB_OUTPUT
        elif [[ "$COMMAND" == *"review"* ]]; then
          echo "action=review" >> $GITHUB_OUTPUT
        elif [[ "$COMMAND" == *"test"* ]]; then
          echo "action=test" >> $GITHUB_OUTPUT
        elif [[ "$COMMAND" == *"fix"* ]]; then
          echo "action=fix" >> $GITHUB_OUTPUT
        elif [[ "$COMMAND" == *"implement"* ]]; then
          echo "action=implement" >> $GITHUB_OUTPUT
        else
          echo "action=general" >> $GITHUB_OUTPUT
        fi

    - name: Execute Claude Command
      id: claude-response
      env:
        ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        COMMAND="${{ steps.parse-command.outputs.command }}"
        ACTION="${{ steps.parse-command.outputs.action }}"
        CONTEXT_TYPE="${{ steps.parse-command.outputs.context_type }}"

        echo "ğŸ¤– Executing Claude command: $COMMAND"
        echo "ğŸ“‹ Action type: $ACTION"
        echo "ğŸ“„ Context: $CONTEXT_TYPE"

        case "$ACTION" in
          "help")
            RESPONSE=$(cat << 'EOF'
        ğŸ¤– **Claude Code å¯ç”¨å‘½ä»¤**

        **åŸºç¡€å‘½ä»¤:**
        - \`@claude help\` - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯
        - \`@claude status\` - æ£€æŸ¥é¡¹ç›®çŠ¶æ€å’ŒCI/CD
        - \`@claude review\` - ä»£ç å®¡æŸ¥å’Œå»ºè®®

        **å¼€å‘å‘½ä»¤:**
        - \`@claude test\` - è¿è¡Œæµ‹è¯•å¹¶åˆ†æç»“æœ
        - \`@claude fix [issue]\` - ä¿®å¤æŒ‡å®šé—®é¢˜
        - \`@claude implement [feature]\` - å®ç°æ–°åŠŸèƒ½

        **é«˜çº§åŠŸèƒ½:**
        - \`@claude analyze\` - åˆ†æä»£ç åº“ç»“æ„
        - \`@claude optimize\` - æ€§èƒ½ä¼˜åŒ–å»ºè®®
        - \`@claude document\` - ç”Ÿæˆæˆ–æ›´æ–°æ–‡æ¡£

        **ç¤ºä¾‹:**
        - \`@claude fix the failing CI test\`
        - \`@claude implement user authentication\`
        - \`@claude review my pull request\`
        EOF
        )
            ;;
          "status")
            # è·å–é¡¹ç›®çŠ¶æ€ä¿¡æ¯
            RESPONSE=$(cat << EOF
        ğŸ“Š **é¡¹ç›®çŠ¶æ€æŠ¥å‘Š**

        **ğŸ”§ CI/CDçŠ¶æ€:**
        - æœ€æ–°æäº¤: ${{ github.sha }}
        - åˆ†æ”¯: ${{ github.ref_name }}
        - å·¥ä½œæµè¿è¡ŒçŠ¶æ€: [æŸ¥çœ‹è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions)

        **ğŸ“ æœ€è¿‘æ´»åŠ¨:**
        - è§¦å‘äº‹ä»¶: ${{ github.event_name }}
        - æ“ä½œè€…: ${{ github.actor }}
        - æ—¶é—´: $(date -u)

        **ğŸ—ï¸ é¡¹ç›®ç»“æ„:**
        - ä¸»è¦æ¨¡å—: brain/ (è®¤çŸ¥æ ¸å¿ƒ), perception/ (æ„ŸçŸ¥), fusion/ (èåˆ)
        - é…ç½®æ–‡ä»¶: config/, requirements.txt
        - æ–‡æ¡£: docs/, README.md

        **å»ºè®®ä¸‹ä¸€æ­¥æ“ä½œ:**
        - è¿è¡Œ \`@claude test\` æ£€æŸ¥ä»£ç è´¨é‡
        - ä½¿ç”¨ \`@claude review\` è¿›è¡Œä»£ç å®¡æŸ¥
        EOF
        )
            ;;
          "review")
            # æ‰§è¡Œä»£ç å®¡æŸ¥
            echo "ğŸ” Performing code review..."
            RESPONSE="ğŸ” **ä»£ç å®¡æŸ¥æŠ¥å‘Š**

        **æ­£åœ¨åˆ†ææ‚¨çš„ä»£ç ...**

        **æ£€æŸ¥é¡¹ç›®:**
        - æ–‡ä»¶å˜æ›´åˆ†æ
        - ä»£ç è´¨é‡è¯„ä¼°
        - å®‰å…¨æ€§æ£€æŸ¥
        - æ€§èƒ½å»ºè®®

        **æ³¨æ„:** è¯¦ç»†çš„ä»£ç å®¡æŸ¥éœ€è¦å…·ä½“çš„æ–‡ä»¶ä¸Šä¸‹æ–‡ã€‚å»ºè®®åœ¨PRä¸­ä½¿ç”¨æ­¤å‘½ä»¤ã€‚
        "
            ;;
          "test")
            RESPONSE="ğŸ§ª **æµ‹è¯•æ‰§è¡Œä¸­...**

        **æ­£åœ¨è¿è¡Œæµ‹è¯•å¥—ä»¶:**
        - å•å…ƒæµ‹è¯•
        - é›†æˆæµ‹è¯•
        - ä»£ç è¦†ç›–ç‡
        - æ€§èƒ½æµ‹è¯•

        **æµ‹è¯•ç»“æœå°†æ˜¾ç¤ºåœ¨CI/CDæ—¥å¿—ä¸­ã€‚**
        "
            ;;
          *)
            # ä½¿ç”¨Claude APIå¤„ç†é€šç”¨è¯·æ±‚
            if [ -n "$ANTHROPIC_API_KEY" ] && [ -n "$ANTHROPIC_BASE_URL" ]; then
              echo "ğŸŒ Calling Claude API..."
              RESPONSE=$(curl -s -X POST "$ANTHROPIC_BASE_URL/v1/messages" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $ANTHROPIC_API_KEY" \
                -H "anthropic-version: 2023-06-01" \
                -d "{
                  \"model\": \"claude-3-sonnet-20240229\",
                  \"max_tokens\": 1000,
                  \"messages\": [
                    {
                      \"role\": \"user\",
                      \"content\": \"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»£ç åŠ©æ‰‹ã€‚ç”¨æˆ·åœ¨GitHubé¡¹ç›®ä¸­æåˆ°äº†ä½ : $COMMAND\\n\\né¡¹ç›®èƒŒæ™¯: è¿™æ˜¯ä¸€ä¸ªåä¸º'Brain'çš„æ— äººç³»ç»Ÿä»»åŠ¡åˆ†è§£å¤§è„‘é¡¹ç›®ï¼ŒåŒ…å«æ„ŸçŸ¥ã€èåˆã€è®¤çŸ¥ç­‰æ¨¡å—ã€‚\\n\\nè¯·æä¾›æœ‰ç”¨çš„å›å¤ï¼ŒåŒ…æ‹¬ä»£ç å»ºè®®ã€è§£å†³æ–¹æ¡ˆæˆ–æŒ‡å¯¼ã€‚å›å¤è¦ç®€æ´å®ç”¨ã€‚\"
                    }
                  ]
                }" | jq -r '.content[0].text // "APIè°ƒç”¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®"')
            else
              RESPONSE="ğŸ¤– **Claude Code å“åº”**

        æ”¶åˆ°å‘½ä»¤: \`${COMMAND}\`

        **å½“å‰çŠ¶æ€:**
        - Claude APIé…ç½®: ${ANTHROPIC_API_KEY:+âœ… å·²é…ç½®}${ANTHROPIC_API_KEY:-âŒ æœªé…ç½®}
        - åŸºç¡€åŠŸèƒ½: âœ… å¯ç”¨
        - é«˜çº§AIåŠŸèƒ½: âš ï¸ éœ€è¦APIé…ç½®

        **å»ºè®®:**
        1. é…ç½®ANTHROPIC_API_KEYå’ŒANTHROPIC_BASE_URL secrets
        2. ä½¿ç”¨ \`@claude help\` æŸ¥çœ‹å¯ç”¨å‘½ä»¤
        3. å°è¯•å…·ä½“çš„å¼€å‘å‘½ä»¤å¦‚ \`@claude fix issue\`
        "
            fi
            ;;
        esac

        echo "response<<EOF" >> $GITHUB_OUTPUT
        echo "$RESPONSE" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create Response Comment
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const response = `${{ steps.claude-response.outputs.response }}`;
          const issueNumber = parseInt('${{ steps.parse-command.outputs.issue_number }}');

          // æ·»åŠ å“åº”å¤´å’Œæ—¶é—´æˆ³
          const timestamp = new Date().toISOString();
          const responseWithMeta = `ğŸ¤– **Claude Code Assistant** (${timestamp})

        ${response}

        ---
        *ç”± Claude Code GitHub Actions è‡ªåŠ¨ç”Ÿæˆ | [æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        *`;

          try {
            if (context.payload.issue) {
              // Issueæˆ–PRè¯„è®º
              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: responseWithMeta
              });
            } else if (context.payload.pull_request) {
              // PRè¯„è®º
              await github.rest.issues.createComment({
                issue_number: context.payload.pull_request.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: responseWithMeta
              });
            }
          } catch (error) {
            console.log('Comment creation failed:', error);
          }

    - name: Log Claude interaction
      run: |
        echo "ğŸ“ Claude interaction logged:"
        echo "ğŸ‘¤ User: ${{ github.actor }}"
        echo "ğŸ“„ Context: ${{ steps.parse-command.outputs.context_type }}"
        echo "âš¡ Action: ${{ steps.parse-command.outputs.action }}"
        echo "ğŸ’¬ Command: ${{ steps.parse-command.outputs.command }}"
        echo "ğŸ”— URL: ${{ github.server_url }}/${{ github.repository }}/${{ steps.parse-command.outputs.context_type }}/${{ steps.parse-command.outputs.issue_number }}"
        echo "â° Time: $(date -u)"