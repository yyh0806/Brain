name: Branch Protection and PR Validation

on:
  pull_request:
    branches: [ master, main ]
  push:
    branches: [ master, main ]

jobs:
  prevent-direct-push:
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    steps:
    - name: Check if push is direct
      run: |
        echo "âŒ ç›´æ¥æ¨é€åˆ°masteråˆ†æ”¯æ˜¯ä¸è¢«å…è®¸çš„ï¼"
        echo "è¯·é€šè¿‡Pull Requestçš„æ–¹å¼æ¥æäº¤ä»£ç "
        exit 1

  pr-validation:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check PR requirements
      run: |
        echo "âœ… PRåˆ›å»ºæˆåŠŸ"
        echo "ğŸ“Š PRä¿¡æ¯:"
        echo "  - æ¥æºåˆ†æ”¯: ${{ github.head_ref }}"
        echo "  - ç›®æ ‡åˆ†æ”¯: ${{ github.base_ref }}"
        echo "  - PRä½œè€…: ${{ github.actor }}"

    - name: Run code quality checks
      run: |
        echo "ğŸ” è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥..."

        # æ£€æŸ¥Pythonä»£ç æ ¼å¼
        if command -v python3 >/dev/null 2>&1; then
          echo "æ£€æŸ¥Pythonæ–‡ä»¶..."
          find . -name "*.py" -not -path "./.*" -not -path "./venv/*" -not -path "./env/*" | head -5
        fi

    - name: Check commit messages
      run: |
        echo "ğŸ“ æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼..."

        # è·å–æœ€æ–°çš„æäº¤ä¿¡æ¯
        COMMIT_MSG=$(git log -1 --pretty=format:"%s")
        echo "æœ€æ–°æäº¤ä¿¡æ¯: $COMMIT_MSG"

        # ç®€å•çš„æäº¤ä¿¡æ¯æ ¼å¼æ£€æŸ¥
        if [[ ${#COMMIT_MSG} -lt 10 ]]; then
          echo "âš ï¸ æäº¤ä¿¡æ¯å¤ªçŸ­ï¼Œè¯·æä¾›æ›´è¯¦ç»†çš„æè¿°"
        fi

  merge-check:
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
    - name: Log merge information
      run: |
        echo "ğŸ‰ PRå·²åˆå¹¶åˆ°master"
        echo "ğŸ“ˆ åˆå¹¶ä¿¡æ¯:"
        echo "  - PRç¼–å·: #${{ github.event.pull_request.number }}"
        echo "  - åˆå¹¶è€…: ${{ github.event.pull_request.merged_by.login }}"
        echo "  - åˆå¹¶æ—¶é—´: $(date)"