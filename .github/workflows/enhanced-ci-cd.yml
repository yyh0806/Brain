name: Enhanced CI/CD with Code Review

on:
  pull_request:
    branches: [ master, main ]
    types: [opened, synchronize, reopened]
  push:
    branches: [ develop, feature/*, hotfix/* ]

env:
  PYTHON_VERSION: '3.9'

jobs:
  code-quality:
    runs-on: ubuntu-latest
    name: ä»£ç è´¨é‡æ£€æŸ¥

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        pip install flake8 black isort mypy pytest

    - name: Run code formatting check (black)
      run: |
        echo "ğŸ¨ æ£€æŸ¥ä»£ç æ ¼å¼ (black)..."
        black --check --diff brain/ || true

    - name: Run import sorting check (isort)
      run: |
        echo "ğŸ“š æ£€æŸ¥importæ’åº (isort)..."
        isort --check-only --diff brain/ || true

    - name: Run linting (flake8)
      run: |
        echo "ğŸ” è¿è¡Œä»£ç æ£€æŸ¥ (flake8)..."
        flake8 brain/ --max-line-length=88 --ignore=E203,W503 || true

    - name: Run type checking (mypy)
      run: |
        echo "ğŸ“Š è¿è¡Œç±»å‹æ£€æŸ¥ (mypy)..."
        mypy brain/ --ignore-missing-imports || true

  security-scan:
    runs-on: ubuntu-latest
    name: å®‰å…¨æ‰«æ

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run security scan
      run: |
        echo "ğŸ”’ è¿è¡Œå®‰å…¨æ‰«æ..."

        # æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
        echo "æ£€æŸ¥å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯..."
        if grep -r -i "password\|secret\|token\|key" --include="*.py" --include="*.yaml" --include="*.yml" brain/ ; then
          echo "âš ï¸ å‘ç°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯ï¼Œè¯·æ£€æŸ¥"
        fi

        # æ£€æŸ¥ç¡¬ç¼–ç çš„APIå¯†é’¥
        echo "æ£€æŸ¥ç¡¬ç¼–ç çš„APIå¯†é’¥..."
        if grep -r -E "sk-[a-zA-Z0-9]{48}" --include="*.py" --include="*.yaml" brain/ ; then
          echo "âŒ å‘ç°ç¡¬ç¼–ç çš„APIå¯†é’¥ï¼"
          exit 1
        fi

  tests:
    runs-on: ubuntu-latest
    name: æµ‹è¯•è¿è¡Œ

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        pip install pytest pytest-cov

    - name: Run tests
      run: |
        echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
        if [ -d "tests" ]; then
          pytest tests/ --cov=brain --cov-report=xml || true
        else
          echo "â„¹ï¸ æœªæ‰¾åˆ°æµ‹è¯•ç›®å½•"
        fi

  pr-review-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    name: PRå®¡æŸ¥æ£€æŸ¥

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check PR size
      run: |
        echo "ğŸ“Š æ£€æŸ¥PRå¤§å°..."
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | wc -l)
        echo "å˜æ›´æ–‡ä»¶æ•°: $CHANGED_FILES"

        if [ "$CHANGED_FILES" -gt 20 ]; then
          echo "âš ï¸ PRåŒ…å«å¤§é‡æ–‡ä»¶å˜æ›´ï¼Œå»ºè®®æ‹†åˆ†ä¸ºæ›´å°çš„PR"
        fi

    - name: Check for documentation changes
      run: |
        echo "ğŸ“š æ£€æŸ¥æ–‡æ¡£æ›´æ–°..."
        DOC_CHANGED=false

        if git diff --name-only HEAD~1 HEAD | grep -E "\.md$|\.rst$|docs/"; then
          DOC_CHANGED=true
          echo "âœ… æ£€æµ‹åˆ°æ–‡æ¡£æ›´æ–°"
        fi

        if [ "$DOC_CHANGED" = false ]; then
          echo "ğŸ’¡ å»ºè®®æ›´æ–°ç›¸å…³æ–‡æ¡£"
        fi

    - name: Comment on PR
      uses: actions/github-script@v6
      with:
        script: |
          const prNumber = context.issue.number;
          const comment = `
          ## ğŸ¤– è‡ªåŠ¨ä»£ç å®¡æŸ¥æŠ¥å‘Š

          ### âœ… æ£€æŸ¥é¡¹ç›®
          - [x] ä»£ç è´¨é‡æ£€æŸ¥
          - [x] å®‰å…¨æ‰«æ
          - [x] æµ‹è¯•è¿è¡Œ
          - [x] PRå¤§å°æ£€æŸ¥
          - [x] æ–‡æ¡£æ›´æ–°æ£€æŸ¥

          ### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
          - å˜æ›´æ–‡ä»¶æ•°: ${{ steps.check-pr-size.outputs.changed-files || 'æ­£åœ¨è®¡ç®—...' }}
          - PRä½œè€…: ${{ github.actor }}
          - åˆ›å»ºæ—¶é—´: ${{ github.event.pull_request.created_at }}

          ### ğŸ’¡ å»ºè®®
          - è¯·ç¡®ä¿ä»£ç ç¬¦åˆé¡¹ç›®ç¼–ç è§„èŒƒ
          - æ›´æ–°ç›¸å…³æ–‡æ¡£å’Œæµ‹è¯•
          - ä¿æŒPRçš„å°è€Œä¸“æ³¨
          `;

          github.rest.issues.createComment({
            issue_number: prNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  deploy-simulation:
    if: github.event_name == 'pull_request' && github.base_ref == 'master'
    runs-on: ubuntu-latest
    name: éƒ¨ç½²æ¨¡æ‹Ÿ
    needs: [code-quality, security-scan, tests]

    steps:
    - name: Simulate deployment
      run: |
        echo "ğŸš€ æ¨¡æ‹Ÿéƒ¨ç½²æµç¨‹..."
        echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å®‰å…¨åˆå¹¶åˆ°master"
        echo "ğŸ“‹ éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•:"
        echo "  - [ ] ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡"
        echo "  - [ ] å®‰å…¨æ‰«æé€šè¿‡"
        echo "  - [ ] æµ‹è¯•å…¨éƒ¨é€šè¿‡"
        echo "  - [ ] æ–‡æ¡£å·²æ›´æ–°"
        echo "  - [ ] PRå·²è·å¾—è¶³å¤Ÿçš„å®¡æ ¸"